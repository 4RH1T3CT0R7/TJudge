# TJudge — Руководство пользователя

## Содержание

1. [Введение](#введение)
2. [Быстрый старт](#быстрый-старт)
3. [Руководство пользователя](#руководство-пользователя)
4. [Руководство администратора](#руководство-администратора)
5. [Поддерживаемые игры](#поддерживаемые-игры)
6. [Написание программ-стратегий](#написание-программ-стратегий)
7. [TJudge CLI](#tjudge-cli)
8. [Архитектура системы](#архитектура-системы)
9. [API Reference](#api-reference)
10. [Устранение неполадок](#устранение-неполадок)

---

## Введение

**TJudge** — это высоконагруженная турнирная система для проведения соревнований по теории игр. Система позволяет:

- Создавать турниры с различными играми
- Загружать программы-стратегии на любом языке программирования
- Автоматически проводить матчи между программами
- Отслеживать рейтинг в режиме реального времени
- Работать в командах

### Основные возможности

| Возможность | Описание |
|-------------|----------|
| Многопользовательский режим | Регистрация, команды, рейтинги |
| Множество игр | Дилемма заключённого, Перетягивание каната |
| Безопасное выполнение | Изолированные Docker-контейнеры |
| Real-time обновления | WebSocket для таблицы лидеров |
| Автомасштабирование | До 1000 параллельных матчей |

---

## Быстрый старт

### Требования

- Docker и Docker Compose
- 4GB RAM минимум
- 10GB свободного места на диске

### Запуск системы

```bash
# Клонирование репозитория
git clone https://github.com/bmstu-itstech/tjudge.git
cd tjudge

# Запуск всех сервисов
docker-compose up -d

# Проверка статуса
docker-compose ps
```

### Доступ к интерфейсам

| Сервис | URL | Описание |
|--------|-----|----------|
| Веб-интерфейс | http://localhost:8080 | Основной интерфейс |
| Grafana | http://localhost:3000 | Мониторинг (admin/admin) |
| Prometheus | http://localhost:9092 | Метрики |

### Первые шаги

1. Откройте http://localhost:8080
2. Зарегистрируйтесь
3. Перейдите в раздел «Турниры»
4. Присоединитесь к турниру или создайте команду
5. Загрузите свою программу-стратегию для каждой игры

---

## Руководство пользователя

### Регистрация и вход

#### Регистрация

1. Перейдите на http://localhost:8080/register
2. Заполните форму:
   - **Имя пользователя** — уникальное, латиницей
   - **Email** — для восстановления пароля
   - **Пароль** — минимум 8 символов
3. Нажмите «Зарегистрироваться»

#### Вход

1. Перейдите на http://localhost:8080/login
2. Введите email и пароль
3. Нажмите «Войти»

> **Важно:** Сессия сохраняется между перезагрузками страницы. При истечении токена потребуется повторный вход.

### Участие в турнирах

#### Просмотр турниров

1. Перейдите в раздел «Турниры»
2. Доступные фильтры:
   - По статусу (Ожидание / Активный / Завершён)
   - По типу

#### Присоединение к турниру

**Способ 1: Создать команду**
1. Откройте страницу турнира
2. Нажмите «Участвовать»
3. Введите название команды
4. Нажмите «Создать»

**Способ 2: Присоединиться по коду**
1. Получите код приглашения от лидера команды
2. Нажмите «Участвовать»
3. Введите код в поле «Код приглашения»
4. Нажмите «Вступить»

#### Управление командой

Если вы лидер команды:

1. Перейдите в «Управление командой»
2. Доступные действия:
   - Скопировать код приглашения
   - Исключить участника
   - Покинуть команду (передаёт лидерство)

### Загрузка программ

#### Требования к программам

- Программа должна читать из **stdin** и писать в **stdout**
- Формат ввода/вывода зависит от типа игры
- Таймаут ответа: **500ms**
- Поддерживаемые языки: Python, C++, Java, Go, Rust, JavaScript

#### Процесс загрузки

1. Откройте страницу игры в турнире
2. Нажмите «Загрузить программу»
3. Выберите файл с кодом
4. Нажмите «Отправить»

#### Статусы программы

| Статус | Описание |
|--------|----------|
| `pending` | Ожидает проверки |
| `compiling` | Компилируется |
| `ready` | Готова к матчам |
| `error` | Ошибка компиляции |

### Просмотр результатов

#### Таблица лидеров

- Обновляется в реальном времени через WebSocket
- Показывает: место, команду, рейтинг, победы/поражения/ничьи
- Кнопка «На весь экран» для проецирования
- Отдельные таблицы для каждой игры турнира

#### История матчей

- Доступна на странице турнира
- Фильтрация по игре, команде, статусу
- Детали каждого матча: счёт, время, ошибки

---

## Руководство администратора

### Получение прав администратора

**Способ 1: Через SQL**
```bash
docker exec tjudge-postgres psql -U tjudge -d tjudge -c \
  "UPDATE users SET role = 'admin' WHERE email = 'your-email@example.com';"
```

**Способ 2: Через Make**
```bash
make admin EMAIL=your-email@example.com
```

> **Важно:** После изменения роли необходимо выйти и войти заново.

### Админ-панель

Доступна по адресу http://localhost:8080/admin

#### Вкладка «Игры»

**Создание игры:**
1. Нажмите «Создать игру»
2. Заполните поля:
   - **Идентификатор** — `snake_case`, например `prisoners_dilemma`
   - **Название** — отображаемое имя
   - **Правила** — Markdown-разметка
   - **Множитель очков** — коэффициент для рейтинга (по умолчанию 1.0)
3. Нажмите «Создать»

**Редактирование:**
- Нажмите на игру в списке
- Измените поля
- Нажмите «Сохранить»

**Удаление:**
- Нажмите «Удалить» рядом с игрой
- Подтвердите действие

#### Вкладка «Турниры»

**Создание турнира:**
1. Нажмите «Создать турнир»
2. Заполните форму:
   - **Название** — обязательно
   - **Описание** — опционально, поддерживает Markdown
   - **Макс. размер команды** — 1-10 человек
   - **Макс. участников** — опционально
   - **Дата начала/окончания** — опционально
   - **Постоянный турнир** — всегда принимает участников
3. Нажмите «Создать»

**Добавление игр в турнир:**
1. Откройте страницу турнира
2. Перейдите в раздел «Игры»
3. Выберите игры из списка доступных
4. Нажмите «Добавить»

**Управление турниром:**

| Действие | Описание |
|----------|----------|
| Запустить | Переводит в статус `active`, начинает матчи |
| Завершить | Переводит в статус `completed`, останавливает матчи |
| Удалить | Полностью удаляет турнир |

**Управление раундами по играм:**
- Каждая игра в турнире имеет независимый статус раунда
- Можно запускать/останавливать раунды для отдельных игр
- Статусы: `pending`, `running`, `completed`

### Мониторинг системы

#### Grafana (http://localhost:3000)

Логин: `admin` / Пароль: `admin`

**Готовые дашборды:**
- TJudge Overview — общая статистика
- Match Processing — очередь и обработка матчей
- Worker Pool — состояние воркеров

#### Prometheus (http://localhost:9092)

**Ключевые метрики:**
```promql
# Матчей в очереди
tjudge_queue_size{priority="high"}

# Активных воркеров
tjudge_workers_active

# Обработано матчей
tjudge_matches_processed_total

# Ошибок
tjudge_matches_failed_total
```

### Управление через CLI

```bash
# Применить миграции
make migrate-up

# Откатить миграции
make migrate-down

# Просмотр логов
docker-compose logs -f api
docker-compose logs -f worker

# Перезапуск сервисов
docker-compose restart api worker

# Пересборка образов
make docker-build
```

---

## Поддерживаемые игры

### 1. Дилемма заключённого (Prisoners Dilemma)

**Идентификатор:** `prisoners_dilemma`

#### Правила

Два игрока одновременно выбирают одно из двух действий:
- `Y` — сотрудничать
- `N` — предать

#### Таблица выплат

| Игрок 1 | Игрок 2 | Очки 1 | Очки 2 |
|---------|---------|--------|--------|
| Y | Y | 3 | 3 |
| Y | N | 0 | 5 |
| N | Y | 5 | 0 |
| N | N | 1 | 1 |

#### Протокол взаимодействия

**Ввод (stdin):**
```
<история_ходов_противника>
```

Примеры:
- Первый ход: пустая строка
- После 3 ходов: `YNY`

**Вывод (stdout):**
```
<ваш_ход>
```

Допустимые значения: `Y` или `N`

#### Пример программы (Python)

```python
#!/usr/bin/env python3
import sys

def main():
    # Читаем историю ходов противника
    opponent_history = input().strip()

    if not opponent_history:
        # Первый ход — сотрудничаем
        print("Y")
    else:
        # Tit-for-Tat: повторяем последний ход противника
        print(opponent_history[-1])

if __name__ == "__main__":
    main()
```

---

### 2. Перетягивание каната (Tug of War)

**Идентификатор:** `tug_of_war`

#### Правила

- Начальная энергия: 100 единиц у каждого
- Игроки по очереди тратят энергию
- Побеждает тот, кто вынудит противника сдаться или исчерпать энергию

#### Протокол взаимодействия

**Ввод:**
```
<ваша_энергия> <энергия_противника> <последний_ход_противника>
```

**Вывод:**
- Число от 1 до вашей энергии — потратить энергию
- `-1` — сдаться

#### Пример программы (Python)

```python
#!/usr/bin/env python3
import sys

def main():
    line = input().strip()
    parts = line.split()

    my_energy = int(parts[0])
    opponent_energy = int(parts[1])

    if my_energy <= 0:
        print(-1)  # Сдаёмся
    elif opponent_energy <= 10:
        # Противник почти без энергии — атакуем
        print(min(my_energy, 20))
    else:
        # Консервативная стратегия
        print(max(1, my_energy // 10))

if __name__ == "__main__":
    main()
```

---

## Написание программ-стратегий

### Общие требования

1. **Ввод/вывод:** stdin/stdout
2. **Таймаут:** 500ms на ответ
3. **Память:** до 256MB
4. **Процессы:** до 32

### Поддерживаемые языки

| Язык | Расширение | Запуск |
|------|------------|--------|
| Python 3 | `.py` | `python3 program.py` |
| C++ | `.cpp` | Компиляция + запуск |
| Java | `.java` | `java Program` |
| Go | `.go` | `go run program.go` |
| JavaScript | `.js` | `node program.js` |
| Rust | `.rs` | Компиляция + запуск |

### Шаблон программы

```python
#!/usr/bin/env python3
"""
Шаблон программы для TJudge.
Замените логику в функции make_decision().
"""
import sys

def make_decision(game_state: str) -> str:
    """
    Принимает решение на основе состояния игры.

    Args:
        game_state: Строка с текущим состоянием (формат зависит от игры)

    Returns:
        Строка с вашим ходом
    """
    # TODO: Реализуйте вашу стратегию
    return "Y"

def main():
    while True:
        try:
            line = input()
            result = make_decision(line)
            print(result, flush=True)
        except EOFError:
            break

if __name__ == "__main__":
    main()
```

### Советы по написанию

1. **Всегда используйте `flush=True`** при выводе
2. **Обрабатывайте EOFError** для корректного завершения
3. **Не используйте сеть** — она заблокирована
4. **Не пишите в файлы** — доступ ограничен
5. **Тестируйте локально** перед загрузкой

### Локальное тестирование

```bash
# Установка локального CLI
cd tjudge
go build -o tjudge-local ./main.go

# Запуск тестового матча
./tjudge-local prisoners_dilemma -c 100 -v ./my_program.py ./opponent.py
```

---

## TJudge CLI

### Описание

**tjudge-cli** — это Rust-приложение для запуска матчей между программами. Оно используется внутри Docker-контейнеров системой TJudge.

### Исходный код

Репозиторий: https://github.com/bmstu-itstech/tjudge-cli

### Сборка образа

```bash
# Сборка Docker-образа с tjudge-cli
make docker-build-executor

# Или напрямую
docker build -t tjudge-cli:latest -f docker/tjudge/Dockerfile .
```

### Использование

```bash
tjudge-cli <GAME_TYPE> [OPTIONS] <PROGRAM1> <PROGRAM2>
```

#### Аргументы

| Аргумент | Описание |
|----------|----------|
| `GAME_TYPE` | Тип игры: `prisoners_dilemma`, `tug_of_war` |
| `PROGRAM1` | Путь к первой программе |
| `PROGRAM2` | Путь к второй программе |

#### Опции

| Опция | Описание | По умолчанию |
|-------|----------|--------------|
| `-i, --iterations N` | Количество раундов | 1000 |
| `-v, --verbose` | Подробный вывод | выкл |

#### Примеры

```bash
# Базовый запуск
tjudge-cli prisoners_dilemma program1.py program2.py

# С 500 итерациями
tjudge-cli prisoners_dilemma -i 500 program1.py program2.py

# С подробным выводом
tjudge-cli prisoners_dilemma -v -i 100 program1.py program2.py
```

### Выходные данные

**Успешное завершение (код 0):**
```
<score1> <score2>
```

**Коды ошибок:**

| Код | Описание | Победитель |
|-----|----------|------------|
| 0 | Успешно | Определяется по счёту |
| 1 | Ошибка программы 1 | Программа 2 |
| 2 | Ошибка программы 2 | Программа 1 |
| 3 | Ошибка системы | Ничья |

### Интеграция с системой

TJudge вызывает tjudge-cli внутри изолированного Docker-контейнера:

```go
// Упрощённый пример вызова
cmd := []string{
    "tjudge-cli",
    gameType,
    "-i", "1000",
    "/programs/program1.py",
    "/programs/program2.py",
}
```

#### Ограничения контейнера

| Параметр | Значение |
|----------|----------|
| CPU | 100ms на 100ms период |
| Память | 512MB |
| Процессы | 100 |
| Сеть | Отключена |
| Файловая система | Только чтение |
| Таймаут | 60 секунд |

---

## Архитектура системы

### Компоненты

```
┌─────────────────────────────────────────────────────────────────┐
│                         Web Browser                              │
│                    (React SPA @ :8080)                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         API Server                               │
│                    (Go Chi @ :8080)                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │   Auth   │ │Tournament│ │  Match   │ │ WebSocket│          │
│  │ Handler  │ │ Handler  │ │ Handler  │ │ Handler  │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
└─────────────────────────────────────────────────────────────────┘
         │                         │                    │
         ▼                         ▼                    ▼
┌─────────────┐           ┌─────────────┐      ┌─────────────┐
│  PostgreSQL │           │    Redis    │      │   Worker    │
│   (Data)    │           │(Cache/Queue)│      │    Pool     │
└─────────────┘           └─────────────┘      └─────────────┘
                                                      │
                                                      ▼
                                            ┌─────────────────┐
                                            │ Docker Executor │
                                            │  (tjudge-cli)   │
                                            └─────────────────┘
```

### Поток обработки матча

```
1. POST /api/v1/tournaments/{id}/matches
              │
              ▼
2. Создание Match (status: pending)
              │
              ▼
3. Добавление в Redis Queue (priority: high/medium/low)
              │
              ▼
4. Worker берёт из очереди
              │
              ▼
5. Обновление status → running
              │
              ▼
6. Запуск Docker контейнера с tjudge-cli
              │
              ▼
7. Парсинг результата
              │
              ▼
8. Обновление status → completed/failed
              │
              ▼
9. Обновление рейтингов (ELO)
              │
              ▼
10. WebSocket уведомление клиентам
```

### Очередь с приоритетами

```
queue:high   ──► [Матчи высокого приоритета]  ──┐
queue:medium ──► [Матчи среднего приоритета] ──┼──► Worker Pool
queue:low    ──► [Матчи низкого приоритета]  ──┘
```

Воркеры сначала берут из `high`, затем `medium`, затем `low`.

### Автомасштабирование воркеров

| Размер очереди | Действие |
|----------------|----------|
| > 100 задач | +10 воркеров |
| > 50 задач | +5 воркеров |
| < 10 задач и >50% простаивают | -5 воркеров |

Диапазон: 2 – 100+ воркеров (настраивается через переменные окружения).

---

## API Reference

### Аутентификация

```bash
# Регистрация
POST /api/v1/auth/register
Content-Type: application/json
{
  "username": "user1",
  "email": "user@example.com",
  "password": "password123"
}

# Вход
POST /api/v1/auth/login
Content-Type: application/json
{
  "email": "user@example.com",
  "password": "password123"
}

# Ответ
{
  "access_token": "eyJ...",
  "refresh_token": "eyJ...",
  "user": { "id": "...", "username": "user1", "role": "user" }
}
```

### Турниры

```bash
# Список турниров
GET /api/v1/tournaments

# Создание турнира (требуется auth + admin)
POST /api/v1/tournaments
Authorization: Bearer <token>
{
  "name": "Турнир 1",
  "description": "Описание",
  "max_team_size": 3
}

# Получение турнира
GET /api/v1/tournaments/{id}

# Таблица лидеров
GET /api/v1/tournaments/{id}/leaderboard?limit=100

# Запуск турнира (требуется auth + admin/creator)
POST /api/v1/tournaments/{id}/start

# Завершение турнира
POST /api/v1/tournaments/{id}/complete
```

### Игры

```bash
# Список игр
GET /api/v1/games

# Создание игры (требуется auth + admin)
POST /api/v1/games
Authorization: Bearer <token>
{
  "slug": "prisoners_dilemma",
  "name": "Дилемма заключённого",
  "rules": "# Правила\n\nМаркдаун описание...",
  "score_multiplier": 1.0
}

# Получение игры
GET /api/v1/games/{id}

# Обновление игры
PUT /api/v1/games/{id}
```

### Команды

```bash
# Создание команды
POST /api/v1/teams
Authorization: Bearer <token>
{
  "tournament_id": "...",
  "name": "Команда 1"
}

# Присоединение по коду
POST /api/v1/teams/join
Authorization: Bearer <token>
{
  "code": "ABC123"
}

# Покинуть команду
POST /api/v1/teams/{id}/leave
```

### Программы

```bash
# Загрузка программы
POST /api/v1/programs
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <binary>
tournament_id: "..."
game_id: "..."
name: "My Strategy"

# Список программ
GET /api/v1/programs?tournament_id=...&game_id=...
```

### WebSocket

```javascript
// Подключение
const ws = new WebSocket(
  'ws://localhost:8080/api/v1/ws/tournaments/{id}?token=<access_token>'
);

// Сообщения
ws.onmessage = (event) => {
  const message = JSON.parse(event.data);

  switch (message.type) {
    case 'leaderboard_update':
      // message.payload.entries — новая таблица лидеров
      break;
    case 'match_update':
      // message.payload.match — обновлённый матч
      break;
  }
};
```

---

## Устранение неполадок

### Программа не запускается

**Симптом:** Статус программы `error`

**Решения:**
1. Проверьте shebang (`#!/usr/bin/env python3`)
2. Убедитесь, что файл читает из stdin
3. Проверьте синтаксис локально

### Таймаут при выполнении

**Симптом:** Матч завершается с ошибкой таймаута

**Решения:**
1. Оптимизируйте алгоритм
2. Используйте `flush=True` при выводе
3. Не используйте бесконечные циклы

### WebSocket не подключается

**Симптом:** Ошибка 401 при подключении

**Решения:**
1. Перелогиньтесь (токен мог истечь)
2. Проверьте, что токен передаётся в query-параметре

### Матчи не обрабатываются

**Симптом:** Матчи застряли в статусе `pending`

**Решения:**
```bash
# Проверьте воркеры
docker-compose logs worker

# Перезапустите воркеры
docker-compose restart worker

# Проверьте очередь Redis
docker exec tjudge-redis redis-cli LLEN queue:high
```

### База данных недоступна

**Симптом:** Ошибки подключения к PostgreSQL

**Решения:**
```bash
# Проверьте статус
docker-compose ps postgres

# Проверьте логи
docker-compose logs postgres

# Перезапустите
docker-compose restart postgres
```

---

## Полезные команды

```bash
# Просмотр всех логов
docker-compose logs -f

# Очистка Redis
docker exec tjudge-redis redis-cli FLUSHALL

# Подключение к PostgreSQL
docker exec -it tjudge-postgres psql -U tjudge -d tjudge

# Проверка здоровья API
curl http://localhost:8080/health

# Метрики API
curl http://localhost:8080/metrics

# Пересборка и перезапуск
docker-compose down && docker-compose up -d --build
```

---

## Контакты и поддержка

- **GitHub Issues:** https://github.com/bmstu-itstech/tjudge/issues
- **Документация:** https://github.com/bmstu-itstech/tjudge/docs

---

*Версия документации: 2.0*
*Последнее обновление: Январь 2026*
