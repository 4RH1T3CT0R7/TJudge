# Sealed Secrets — безопасное хранение секретов в Git
# https://github.com/bitnami-labs/sealed-secrets
#
# Установка контроллера:
#   helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
#   helm install sealed-secrets sealed-secrets/sealed-secrets -n kube-system
#
# Установка kubeseal CLI:
#   brew install kubeseal  # macOS
#   # или скачать с GitHub releases
#
# Использование:
#   1. Создайте обычный Secret:
#      kubectl create secret generic tjudge-secrets \
#        --from-literal=DB_PASSWORD=your-password \
#        --dry-run=client -o yaml > secret.yaml
#
#   2. Зашифруйте:
#      kubeseal --format yaml < secret.yaml > sealed-secret.yaml
#
#   3. Примените:
#      kubectl apply -f sealed-secret.yaml

---
# Пример SealedSecret (зашифрованные значения — плейсхолдеры)
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: tjudge-secrets
  namespace: tjudge
  annotations:
    # Секрет можно расшифровать только в этом namespace
    sealedsecrets.bitnami.com/namespace-wide: "true"
spec:
  encryptedData:
    # Зашифрованные значения (замените на реальные через kubeseal)
    DB_PASSWORD: AgBy8hCi...  # kubeseal зашифрует
    JWT_SECRET: AgCK9jDk...   # kubeseal зашифрует
    REDIS_PASSWORD: AgEm7nFl... # kubeseal зашифрует
  template:
    metadata:
      name: tjudge-secrets
      namespace: tjudge
      labels:
        app.kubernetes.io/name: tjudge
        app.kubernetes.io/component: secrets
    type: Opaque

---
# Скрипт для генерации sealed secrets
# Сохраните как scripts/seal-secrets.sh и выполните

# #!/bin/bash
# set -e
#
# NAMESPACE="tjudge"
# SECRET_NAME="tjudge-secrets"
#
# # Запросите значения
# read -sp "DB_PASSWORD: " DB_PASSWORD; echo
# read -sp "JWT_SECRET: " JWT_SECRET; echo
# read -sp "REDIS_PASSWORD: " REDIS_PASSWORD; echo
#
# # Создайте и зашифруйте секрет
# kubectl create secret generic $SECRET_NAME \
#   --namespace=$NAMESPACE \
#   --from-literal=DB_PASSWORD="$DB_PASSWORD" \
#   --from-literal=JWT_SECRET="$JWT_SECRET" \
#   --from-literal=REDIS_PASSWORD="$REDIS_PASSWORD" \
#   --dry-run=client -o yaml | \
#   kubeseal --format yaml > deployments/kubernetes/sealed-secret.yaml
#
# echo "Sealed secret создан: deployments/kubernetes/sealed-secret.yaml"
